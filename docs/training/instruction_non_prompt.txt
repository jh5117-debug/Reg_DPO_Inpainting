================================================================
          DiffuEraser Finetune åˆä½œè€…æ“ä½œæŒ‡å— (ä¸€é”®éƒ¨ç½²ç‰ˆ)
================================================================

äºŒã€åˆä½œè€…è¿™è¾¹ï¼šä¸‹è½½ä¸è¿˜åŸ

2.1 ç¯å¢ƒä¸‹è½½
----------------------------------------------------------------
é¦–å…ˆç¡®ä¿å®‰è£…äº† HuggingFace å·¥å…·å¹¶ç™»å½•ï¼š

pip install -U huggingface_hub
huggingface-cli login
# (æŒ‰æç¤ºè¾“å…¥ Token)

2.2 ä¸‹è½½æ‰€æœ‰æ–‡ä»¶
----------------------------------------------------------------
å»ºè®®åœ¨ Home ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œä¾‹å¦‚ `DiffuEraser_finetune`ï¼š

mkdir -p ~/DiffuEraser_finetune
cd ~/DiffuEraser_finetune

# 1. ä¸‹è½½ä»£ç ã€æ•°æ®é›†ã€è„šæœ¬ (Code Repo)
huggingface-cli download JiaHuang01/DiffuEraser-finetune-code \
    --repo-type dataset \
    --local-dir ./

# 2. ä¸‹è½½æƒé‡æ–‡ä»¶ (Weights Repo)
# æ³¨æ„ï¼šè¿™ä¼šè‡ªåŠ¨å°†æƒé‡ä¸‹è½½åˆ° weights/ å­ç›®å½•ä¸‹
mkdir -p weights
huggingface-cli download JiaHuang01/DiffuEraser-finetune-weights \
    --repo-type dataset \
    --local-dir weights/

2.3 ğŸš€ ä¸€é”®è¿˜åŸé¡¹ç›®ç»“æ„
----------------------------------------------------------------
ä¸‹è½½å®Œæˆåï¼Œä½ ä¼šçœ‹åˆ°å‡ ä¸ªå‹ç¼©åŒ… (code_base.tar.gz, DAVIS.tar ç­‰)ã€‚
ç›´æ¥è¿è¡Œæˆ‘æä¾›çš„ä¸€é”®è¿˜åŸè„šæœ¬ï¼š

cd ~/DiffuEraser_finetune
bash setup_project.sh

å½“çœ‹åˆ° "ğŸ‰ Setup Complete!" æ—¶ï¼Œè¯´æ˜ä»£ç ã€æ•°æ®é›†ã€æƒé‡éƒ½å·²ç»è‡ªåŠ¨è§£å‹å¹¶å½’ä½ã€‚

2.4 å®‰è£… Python ä¾èµ–
----------------------------------------------------------------
è§£å‹åï¼Œé¡¹ç›®æ ¹ç›®å½•ä¸‹ä¼šæœ‰ `requirements.txt` å’Œ `environment.yml`ã€‚

æ¨èä½¿ç”¨ Conda åˆ›å»ºæ–°ç¯å¢ƒï¼š

conda create -n diffueraser python=3.10 -y
conda activate diffueraser

# å®‰è£…æ ¸å¿ƒä¾èµ– (æ¨è)
# conda env create -f environment.yml

2.5 é…ç½® Accelerate
----------------------------------------------------------------
é…ç½®å¤šå¡è®­ç»ƒç¯å¢ƒï¼š

accelerate config

----------------------------------------------------------------
ä¸‰ã€åˆä½œè€…è¿™è¾¹ï¼šè¿è¡Œè®­ç»ƒ
----------------------------------------------------------------

3.1 ä¿®æ”¹è„šæœ¬è·¯å¾„ (ä¸€é”®æ›¿æ¢)
----------------------------------------------------------------
ç”±äºè„šæœ¬é‡Œçš„è·¯å¾„æ˜¯åŸä½œè€…çš„è·¯å¾„ï¼Œéœ€è¦æ›¿æ¢æˆä½ çš„è·¯å¾„ã€‚
å¤åˆ¶ä»¥ä¸‹å‘½ä»¤å¹¶åœ¨ç»ˆç«¯è¿è¡Œå³å¯ï¼š

cd ~/DiffuEraser_finetune

PROJECT_DIR=$(pwd)
WEIGHTS_DIR="${PROJECT_DIR}/weights"

for f in finetune_stage1.sh finetune_stage2.sh run_finetune_all.sbatch save_checkpoint_stage1.py save_checkpoint_stage2.py; do
    sed -i "s|/home/hj/Train_Diffueraser|${PROJECT_DIR}|g" $f
    sed -i "s|/home/hj/DiffuEraser_new/weights|${WEIGHTS_DIR}|g" $f
    echo "Fixed path in $f"
done

3.2 å¼€å§‹è®­ç»ƒ
----------------------------------------------------------------
æ¨èä½¿ç”¨ SLURM æäº¤ä½œä¸šï¼š

mkdir -p logs converted_weights
sbatch run_finetune_all.sbatch



