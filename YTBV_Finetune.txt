================================================================
     DiffuEraser Finetune åˆä½œè€…å®Œæ•´æ“ä½œæŒ‡å— (ç»Ÿä¸€ç‰ˆ)
================================================================

æœ¬æŒ‡å—åŒ…å«ä¸¤ç§ Finetune æ¨¡å¼ï¼š
  A) Non-Prompt ç‰ˆ â€” è®­ç»ƒæ—¶ä½¿ç”¨å›ºå®šæ–‡æœ¬ "clean background"
  B) Prompt ç‰ˆ   â€” è®­ç»ƒæ—¶ä½¿ç”¨ VLM é¢„ç”Ÿæˆçš„çœŸå®åœºæ™¯æè¿°

ä¸¤ç§æ¨¡å¼å…±äº«ç›¸åŒçš„æ•°æ®é›†å’Œæƒé‡ï¼Œä»…è®­ç»ƒè„šæœ¬ä¸åŒã€‚
åˆä½œè€…æŒ‰æœ¬æŒ‡å—æ“ä½œåï¼Œå¯ä»¥è‡ªç”±é€‰æ‹©è¿è¡Œå“ªç§æ¨¡å¼ã€‚

HuggingFace ä»“åº“ï¼š
  1. JiaHuang01/DiffuEraser-finetune-code          (åŸºç¡€ä»£ç  + æ•°æ®é›†)
  2. JiaHuang01/DiffuEraser-finetune-prompt-code    (Prompt ç‰ˆä»£ç  + Captions)
  3. JiaHuang01/DiffuEraser-finetune-weights         (æ¨¡å‹æƒé‡)

================================================================
ç¬¬ä¸€æ­¥ï¼šå‰ç½®ç¯å¢ƒ
================================================================

pip install -U huggingface_hub
huggingface-cli login

================================================================
ç¬¬äºŒæ­¥ï¼šä¸‹è½½æ‰€æœ‰æ–‡ä»¶ï¼ˆä¸€æ¬¡æ€§å…¨éƒ¨ä¸‹è½½ï¼‰
================================================================

mkdir -p ~/DiffuEraser_downloads
cd ~/DiffuEraser_downloads

echo "===== [1/3] ä¸‹è½½åŸºç¡€ä»£ç  + æ•°æ®é›† ====="
huggingface-cli download JiaHuang01/DiffuEraser-finetune-code \
    --repo-type dataset \
    --local-dir ./finetune-code

echo "===== [2/3] ä¸‹è½½ Prompt ç‰ˆä»£ç  + Captions ====="
huggingface-cli download JiaHuang01/DiffuEraser-finetune-prompt-code \
    --repo-type dataset \
    --local-dir ./finetune-prompt-code

echo "===== [3/3] ä¸‹è½½æ¨¡å‹æƒé‡ ====="
huggingface-cli download JiaHuang01/DiffuEraser-finetune-weights \
    --repo-type dataset \
    --local-dir ./finetune-weights

echo "===== ä¸‹è½½å®Œæˆï¼====="

================================================================
ç¬¬ä¸‰æ­¥ï¼šæ­å»º Non-Prompt ç‰ˆæœ¬ (Project A)
================================================================

mkdir -p ~/DiffuEraser_finetune
cd ~/DiffuEraser_finetune

cp ~/DiffuEraser_downloads/finetune-code/code_base.tar.gz .
cp ~/DiffuEraser_downloads/finetune-code/DAVIS.tar .
cp ~/DiffuEraser_downloads/finetune-code/YTBV.tar .
cp ~/DiffuEraser_downloads/finetune-code/setup_project.sh .

mkdir -p weights
cp -r ~/DiffuEraser_downloads/finetune-weights/* weights/

bash setup_project.sh

çœ‹åˆ° "ğŸ‰ Setup Complete!" è¯´æ˜ Non-Prompt ç‰ˆæ­å»ºæˆåŠŸã€‚

================================================================
ç¬¬å››æ­¥ï¼šæ­å»º Prompt ç‰ˆæœ¬ (Project B)
================================================================

Prompt ç‰ˆé€šè¿‡ ç¬¦å·é“¾æ¥ å¤ç”¨ Non-Prompt ç‰ˆçš„æ•°æ®é›†å’Œæƒé‡ï¼Œ
ä¸ä¼šé‡å¤å ç”¨ ~60GB çš„ç£ç›˜ç©ºé—´ã€‚

4.1 åˆ›å»ºç›®å½•ã€è§£å‹ä»£ç 
----------------------------------------------------------------

mkdir -p ~/DiffuEraser_finetune_prompt
cd ~/DiffuEraser_finetune_prompt

tar -xzf ~/DiffuEraser_downloads/finetune-code/code_base.tar.gz

tar -xzf ~/DiffuEraser_downloads/finetune-prompt-code/code_base_prompt.tar.gz

tar -xzf ~/DiffuEraser_downloads/finetune-prompt-code/captions.tar.gz

âš ï¸ æ³¨æ„ï¼šå¿…é¡»å…ˆè§£å‹ code_base.tar.gzï¼Œå†è§£å‹ code_base_prompt.tar.gz
   é¡ºåºä¸èƒ½åï¼Prompt ç‰ˆè„šæœ¬éœ€è¦è¦†ç›– Non-Prompt ç‰ˆåŒåæ–‡ä»¶ã€‚

4.2 åˆ›å»ºç¬¦å·é“¾æ¥ï¼ˆå¤ç”¨æ•°æ®é›† + æƒé‡ï¼‰
----------------------------------------------------------------

ln -sf ~/DiffuEraser_finetune/dataset/DAVIS  dataset/DAVIS
ln -sf ~/DiffuEraser_finetune/dataset/YTBV   dataset/YTBV
ln -sf ~/DiffuEraser_finetune/weights         weights

4.3 éªŒè¯ Prompt ç‰ˆç»“æ„
----------------------------------------------------------------

ls -la dataset/DAVIS dataset/YTBV weights captions/all_captions_merged.yaml

å¦‚æœæ‰€æœ‰ 4 é¡¹éƒ½èƒ½æ­£å¸¸æ˜¾ç¤ºï¼ˆä¸æŠ¥é”™ï¼‰ï¼Œè¯´æ˜ Prompt ç‰ˆæ­å»ºæˆåŠŸã€‚

================================================================
ç¬¬äº”æ­¥ï¼šå®‰è£… Python ä¾èµ–ï¼ˆä¸¤ä¸ªç‰ˆæœ¬å…±ç”¨åŒä¸€ç¯å¢ƒï¼‰
================================================================

cd ~/DiffuEraser_finetune
conda env create -f environment.yml
conda activate diffueraser

================================================================
ç¬¬å…­æ­¥ï¼šé…ç½® Accelerateï¼ˆå¤šå¡è®­ç»ƒï¼‰
================================================================

accelerate config

æ¨èé…ç½®ï¼š
  - This machine / multi-GPU
  - num_processes: ä½ çš„ GPU æ•°é‡ï¼ˆå¦‚ 8ï¼‰
  - mixed_precision: bf16

================================================================
ç¬¬ä¸ƒæ­¥ï¼šä¿®æ”¹è„šæœ¬è·¯å¾„ï¼ˆä¸€é”®æ›¿æ¢ï¼‰
================================================================

è„šæœ¬ä¸­ç¡¬ç¼–ç äº†åŸä½œè€…çš„è·¯å¾„ï¼Œéœ€è¦æ›¿æ¢æˆä½ çš„è·¯å¾„ã€‚
æ ¹æ®ä½ è¦è¿è¡Œçš„ç‰ˆæœ¬ï¼Œæ‰§è¡Œå¯¹åº”çš„æ›¿æ¢å‘½ä»¤ã€‚

7-A) Non-Prompt ç‰ˆè·¯å¾„æ›¿æ¢
----------------------------------------------------------------

cd ~/DiffuEraser_finetune
PROJECT_DIR=$(pwd)
WEIGHTS_DIR="${PROJECT_DIR}/weights"

for f in finetune_stage1.sh finetune_stage2.sh run_finetune_all.sbatch save_checkpoint_stage1.py save_checkpoint_stage2.py; do
    sed -i "s|/home/hj/Train_Diffueraser|${PROJECT_DIR}|g" $f
    sed -i "s|/home/hj/DiffuEraser_new/weights|${WEIGHTS_DIR}|g" $f
    echo "Fixed: $f"
done

7-B) Prompt ç‰ˆè·¯å¾„æ›¿æ¢
----------------------------------------------------------------

cd ~/DiffuEraser_finetune_prompt
PROJECT_DIR=$(pwd)
WEIGHTS_DIR="${PROJECT_DIR}/weights"

for f in finetune_stage1.sh finetune_stage2.sh run_finetune_all.sbatch save_checkpoint_stage1.py save_checkpoint_stage2.py; do
    sed -i "s|/home/hj/Train_Diffueraser_prompt|${PROJECT_DIR}|g" $f
    sed -i "s|/home/hj/Train_Diffueraser/dataset|${PROJECT_DIR}/dataset|g" $f
    sed -i "s|/home/hj/DiffuEraser_new/weights|${WEIGHTS_DIR}|g" $f
    echo "Fixed: $f"
done

================================================================
ç¬¬å…«æ­¥ï¼šå¼€å§‹è®­ç»ƒï¼ˆé€‰æ‹©ä½ è¦è¿è¡Œçš„ç‰ˆæœ¬ï¼‰
================================================================

âš ï¸ æ³¨æ„ï¼šrun_finetune_all.sbatch ä¸­é»˜è®¤ --num_processes 8ï¼Œ
   å¦‚æœä½ çš„ GPU æ•°é‡ä¸åŒï¼Œè¯·æ‰‹åŠ¨ä¿®æ”¹ sbatch æ–‡ä»¶ã€‚

8-A) è¿è¡Œ Non-Prompt ç‰ˆ
----------------------------------------------------------------

cd ~/DiffuEraser_finetune
mkdir -p logs converted_weights
sbatch run_finetune_all.sbatch

æŸ¥çœ‹æ—¥å¿—ï¼š
tail -f logs/DiffuEraser_Total-*.out

8-B) è¿è¡Œ Prompt ç‰ˆ
----------------------------------------------------------------

cd ~/DiffuEraser_finetune_prompt
mkdir -p logs converted_weights
sbatch run_finetune_all.sbatch

æŸ¥çœ‹æ—¥å¿—ï¼š
tail -f logs/DiffuEraser_Prompt-*.out


================================================================
é™„å½• Aï¼šå®Œæˆåçš„ç›®å½•ç»“æ„
================================================================

~/
â”œâ”€â”€ DiffuEraser_downloads/              â† ä¸‹è½½ç¼“å­˜ï¼ˆå¯åˆ é™¤ï¼‰
â”‚   â”œâ”€â”€ finetune-code/
â”‚   â”œâ”€â”€ finetune-prompt-code/
â”‚   â””â”€â”€ finetune-weights/
â”‚
â”œâ”€â”€ DiffuEraser_finetune/               â† Non-Prompt ç‰ˆ
â”‚   â”œâ”€â”€ train_DiffuEraser_stage1.py
â”‚   â”œâ”€â”€ train_DiffuEraser_stage2.py
â”‚   â”œâ”€â”€ finetune_stage1.sh
â”‚   â”œâ”€â”€ finetune_stage2.sh
â”‚   â”œâ”€â”€ run_finetune_all.sbatch
â”‚   â”œâ”€â”€ save_checkpoint_stage1.py
â”‚   â”œâ”€â”€ save_checkpoint_stage2.py
â”‚   â”œâ”€â”€ libs/
â”‚   â”œâ”€â”€ diffueraser/
â”‚   â”œâ”€â”€ propainter/
â”‚   â”œâ”€â”€ dataset/
â”‚   â”‚   â”œâ”€â”€ DAVIS/                      â† çœŸå®æ•°æ® (~844 MB)
â”‚   â”‚   â”œâ”€â”€ YTBV/                       â† çœŸå®æ•°æ® (~5.26 GB)
â”‚   â”‚   â”œâ”€â”€ finetune_dataset.py
â”‚   â”‚   â””â”€â”€ utils.py ...
â”‚   â””â”€â”€ weights/
â”‚       â”œâ”€â”€ stable-diffusion-v1-5/      â† (~35 GB)
â”‚       â”œâ”€â”€ diffuEraser/
â”‚       â”œâ”€â”€ sd-vae-ft-mse/
â”‚       â””â”€â”€ animatediff-motion-adapter-v1-5-2/
â”‚
â””â”€â”€ DiffuEraser_finetune_prompt/        â† Prompt ç‰ˆ
    â”œâ”€â”€ train_DiffuEraser_stage1.py     â† Prompt ç‰ˆ (ä½¿ç”¨ caption)
    â”œâ”€â”€ train_DiffuEraser_stage2.py     â† Prompt ç‰ˆ (ä½¿ç”¨ caption)
    â”œâ”€â”€ finetune_stage1.sh
    â”œâ”€â”€ finetune_stage2.sh
    â”œâ”€â”€ run_finetune_all.sbatch
    â”œâ”€â”€ save_checkpoint_stage1.py
    â”œâ”€â”€ save_checkpoint_stage2.py
    â”œâ”€â”€ generate_captions_ytvos.py
    â”œâ”€â”€ merge_captions.py
    â”œâ”€â”€ libs/
    â”œâ”€â”€ diffueraser/
    â”œâ”€â”€ propainter/
    â”œâ”€â”€ dataset/
    â”‚   â”œâ”€â”€ DAVIS â†’ ç¬¦å·é“¾æ¥åˆ° ../DiffuEraser_finetune/dataset/DAVIS
    â”‚   â”œâ”€â”€ YTBV  â†’ ç¬¦å·é“¾æ¥åˆ° ../DiffuEraser_finetune/dataset/YTBV
    â”‚   â”œâ”€â”€ finetune_dataset.py         â† (ä¸ä½¿ç”¨)
    â”‚   â”œâ”€â”€ finetune_dataset_caption.py â† âœ¨ Prompt ç‰ˆ Dataset
    â”‚   â””â”€â”€ utils.py ...
    â”œâ”€â”€ captions/
    â”‚   â”œâ”€â”€ all_captions_merged.yaml    â† è®­ç»ƒç”¨ (3561 æ¡)
    â”‚   â”œâ”€â”€ all_captions_BR.yaml
    â”‚   â”œâ”€â”€ all_captions_ytvos.yaml
    â”‚   â””â”€â”€ *.yaml
    â””â”€â”€ weights â†’ ç¬¦å·é“¾æ¥åˆ° ../DiffuEraser_finetune/weights

================================================================
é™„å½• Bï¼šä¸¤ç§ç‰ˆæœ¬çš„æ ¸å¿ƒåŒºåˆ«
================================================================

| é¡¹ç›®               | Non-Prompt ç‰ˆ              | Prompt ç‰ˆ                        |
|--------------------|----------------------------|----------------------------------|
| è®­ç»ƒ Caption       | ç¡¬ç¼–ç  "clean background"  | VLM ç”Ÿæˆçš„çœŸå®åœºæ™¯æè¿°           |
| Dataset ç±»         | FinetuneDataset            | FinetuneDatasetWithCaption       |
| æ–°å¢è®­ç»ƒå‚æ•°       | æ—                          | --caption_yaml                   |
| Caption æ•°æ®       | æ—                          | captions/all_captions_merged.yaml|
| Caption æ•°é‡       | 0                          | 3561 (90 DAVIS + 3471 YTVOS)     |
| æƒé‡ / æ•°æ®é›†      | ç›¸åŒ                       | ç›¸åŒ (ç¬¦å·é“¾æ¥)                  |

================================================================
é™„å½• Cï¼šå¸¸è§é—®é¢˜
================================================================

Q1: CUDA OOM æ€ä¹ˆåŠï¼Ÿ
A1: åœ¨ sbatch/sh ä¸­æ·»åŠ æˆ–ç¡®è®¤ --gradient_checkpointingï¼Œ
    æˆ–å‡å° --nframes / --resolution

Q2: å¦‚ä½•æŸ¥çœ‹è®­ç»ƒæ˜¯å¦ä½¿ç”¨äº† Captionï¼Ÿ
A2: æŸ¥çœ‹è®­ç»ƒå¯åŠ¨æ—¥å¿—ï¼ŒPrompt ç‰ˆä¼šæ‰“å°
    "FinetuneDatasetWithCaption: total X videos, 3561 captions loaded"
    Non-Prompt ç‰ˆä¼šæ‰“å°
    "FinetuneDataset: total X videos"

Q3: ä¸¤ä¸ªç‰ˆæœ¬å¯ä»¥åŒæ—¶è¿è¡Œå—ï¼Ÿ
A3: å¯ä»¥ã€‚å®ƒä»¬åœ¨ä¸åŒç›®å½•ï¼Œäº’ä¸å½±å“ã€‚
    ç¡®ä¿ GPU æ•°é‡è¶³å¤Ÿå³å¯ã€‚

Q4: ä¸‹è½½ç¼“å­˜ ~/DiffuEraser_downloads å¯ä»¥åˆ é™¤å—ï¼Ÿ
A4: æ­å»ºå®Œä¸¤ä¸ªç‰ˆæœ¬åå³å¯å®‰å…¨åˆ é™¤ï¼ŒèŠ‚çœç£ç›˜ç©ºé—´ã€‚

Q5: accelerate config æ¯ä¸ªç‰ˆæœ¬è¦å•ç‹¬é…å—ï¼Ÿ
A5: ä¸éœ€è¦ã€‚accelerate config æ˜¯å…¨å±€é…ç½® (~/.cache/huggingface/accelerate/)ï¼Œ
    ä¸¤ä¸ªç‰ˆæœ¬å…±ç”¨åŒä¸€ä»½é…ç½®ã€‚
